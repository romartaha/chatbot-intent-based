FROM ubuntu:22.04 AS build
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    build-essential cmake git python3-pip libssl-dev libcurl4-openssl-dev
RUN apt-get update && apt-get install -y libgomp1

WORKDIR /opt
RUN git clone https://github.com/ggerganov/llama.cpp.git
WORKDIR /opt/llama.cpp
RUN mkdir -p build && cd build \
    && cmake .. \
        -DLLAMA_METAL=OFF \
        -DLLAMA_BUILD_SERVER=ON \
    && cmake --build . --target llama-server --parallel $(nproc)

FROM ubuntu:22.04
RUN apt-get update && apt-get install -y libstdc++6 ca-certificates libcurl4 libgomp1
COPY --from=build /opt/llama.cpp/build/bin/llama-server /usr/local/bin/llama-server
COPY --from=build /opt/llama.cpp/build/bin/*.so /usr/local/lib/
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
WORKDIR /models
EXPOSE 8080
ENTRYPOINT ["/usr/local/bin/llama-server", "-m", "/models/gemma-3-270m-it-UD-Q8_K_XL.gguf", "--port", "8080", "--host", "0.0.0.0"]
